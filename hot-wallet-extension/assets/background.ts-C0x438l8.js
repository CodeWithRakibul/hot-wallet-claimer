import{b as n}from"./browser-polyfill-CP3dh7Ce.js";import{ac as b}from"./chains-BLaPW9iG.js";const f={sidePanel:!1},C=async({sidePanel:e})=>{f.sidePanel=e,await n.storage.local.set({settings:f})};n.storage.local.get("settings").then(e=>{f.sidePanel=e.settings?.sidePanel??f.sidePanel});n.storage.local.onChanged.addListener(e=>{e.settings&&(f.sidePanel=e.settings.newValue?.sidePanel??f.sidePanel)});let l=[];n.windows.onFocusChanged.addListener(async e=>{(await n.windows.get(e)).type==="normal"&&(l=l.filter(r=>r!==e),l.push(e))});n.windows.onRemoved.addListener(e=>{l=l.filter(t=>t!==e)});n.windows.getAll().then(e=>{const t=e.filter(a=>a.type==="normal"&&a.focused);l=[...e.filter(a=>a.type==="normal"&&!a.focused).map(a=>a.id),...t.map(a=>a.id)]});const L=(e,t)=>{if(!e){chrome.sidePanel?.setPanelBehavior({openPanelOnActionClick:!1}),C({sidePanel:!1}),M();return}chrome.sidePanel!=null&&l[l.length-1]&&(C({sidePanel:!0}),n.tabs.remove(t),chrome.sidePanel?.setPanelBehavior({openPanelOnActionClick:!0}),chrome.sidePanel?.open({windowId:l[l.length-1]}))},M=async()=>{let e,t;try{if(!l[l.length-1])throw"No window";const r=await n.windows.get(l[l.length-1]);e=(r.left||0)+(r.width||0)-400-16,t=(r.top||0)+100}catch(r){console.log("OPEN WALLET AS WINDOW",r)}try{const a=(await n.tabs.query({})).find(i=>i.url?.includes(`${n.runtime.id}/frame.html`));if(a)return n.windows.update(a.windowId,{focused:!0,width:400,height:640,left:e,top:t})}catch{}await n.windows.create({url:n.runtime.getURL("frame.html"),type:"popup",focused:!0,width:400,height:640,left:e,top:t})},A=async e=>{try{if(!f.sidePanel)throw"Try to open popup";try{await n.sidePanel.open({windowId:e})}catch{if(!await T("exist",500))throw"Try to open popup"}}catch{await M(),await T("exist")}},T=async(e,t=3e3)=>{const r=`${Math.random()}.${Math.random()}`;n.runtime.sendMessage({id:r,$hot:"wallet:ping",method:e});const a=setInterval(()=>{n.runtime.sendMessage({id:r,$hot:"wallet:ping",method:e})},500);return new Promise(i=>{const w=p=>{console.log("FROM WALLET",p),!(p.id!==r||p.$hot!=="wallet:pong")&&p.value===e&&(n.runtime.onMessage.removeListener(w),clearInterval(a),clearTimeout(g),i(!0))},g=setTimeout(()=>{n.runtime.onMessage.removeListener(w),clearTimeout(a),i(!1)},t);n.runtime.onMessage.addListener(w)})};let h={};n.storage.local.get("connectedApps").then(e=>{h=e.connectedApps||{}});n.storage.local.onChanged.addListener(e=>{h=e.connectedApps?.newValue??h});const P=async({origin:e,evm:t,solana:r,ton:a,near:i})=>{h=(await n.storage.local.get("connectedApps")).connectedApps||{},h[e]==null&&(h[e]={}),(t===null||t)&&(h[e].evm=t),(a===null||a)&&(h[e].ton=a),(i===null||i)&&(h[e].near=i),(r===null||r)&&(h[e].solana=r),await n.storage.local.set({connectedApps:h})},O=e=>h[e]||{ton:null,near:null,evm:null,solana:null},x=async()=>{try{n.scripting.registerContentScripts([{id:"evm-provider",matches:["file://*/*","http://*/*","https://*/*"],js:["extension-scripts/index.js"],runAt:"document_start",world:"MAIN",allFrames:!0},{id:"solana-provider",matches:["file://*/*","http://*/*","https://*/*"],js:["extension-scripts/solana.js"],runAt:"document_start",world:"MAIN",allFrames:!0}])}catch(e){console.error(e)}};x();n.storage.local.get("disableSidePanel").then(({disableSidePanel:e})=>{if(e){n.sidePanel?.setOptions({enabled:!1}),n.action.setPopup({popup:"index.html"});return}n.action.setPopup({popup:""}),n.sidePanel?.setOptions({path:"index.html",enabled:!0}),n.action.onClicked.addListener(t=>A(t.windowId))});n.runtime.onInstalled.addListener(()=>{n.contextMenus.create({id:"openHotWallet",title:"Open HOT Wallet",contexts:["all"]})});n.contextMenus.onClicked.addListener((e,t)=>{e.menuItemId==="openHotWallet"&&t?.windowId!=null&&A(t.windowId)});const I={};n.runtime.onInstalled.addListener(()=>{n.tabs.create({url:n.runtime.getURL("index.html?installed")})});n.runtime.onMessage.addListener((e,t,r)=>{if(e.$hot==="toggleSidePanel")return L(e.value,t?.tab?.id),r(!0),!0;if(e.$hot==="isSiteConnectionType")return b.initializeTask.then(()=>{const a=t?.tab?.id;if(a)return n.tabs.sendMessage(a,{$hot:"setupSiteConnectionType",value:b.isConnectionType(e.origin)}),r(!0),!0});if(e.$hot==="openWallet")return A(t?.tab?.windowId),r(!0),!0;n.storage.local.get("browser").then(({browser:a})=>{if(!a){if(n.storage.local.set({browser:e.value}),e.value==="chrome"){n.sidePanel.setOptions({enabled:!0}),n.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),C({sidePanel:!0});return}n.storage.local.set({disableSidePanel:!0}),n.sidePanel.setOptions?.({enabled:!1,path:""}),n.sidePanel.setPanelBehavior?.({openPanelOnActionClick:!1}),e.value==="arc"&&n.runtime.reload()}})});let y=Promise.resolve();n.runtime.onMessage.addListener(async(e,t)=>{await b.initializeTask;try{const{id:r,$hot:a,request:i,method:w,origin:g}=e,p=t?.tab?.id;if(!p)return;const o=async c=>{console.log("sendSuccessResult",c),await n.tabs.sendMessage(p,{payload:c,$hot:"response:success",method:w,id:r})},u=async c=>{console.log("sendSuccessResult",c),await n.tabs.sendMessage(p,{payload:c,$hot:"response:failed",request:i,method:w,id:r})},v=async(c,d)=>{await n.tabs.sendMessage(p,{$hot:"signal",event:c,payload:d})},m=async()=>{y&&await y,y=A(t.tab.windowId).catch(()=>{});try{await y,await T("wallet:ready"),await n.runtime.sendMessage({$hot:"wallet:request",icon:t?.tab?.favIconUrl,request:e.request,method:e.method,origin:e.origin,context:e.context,id:e.id,tabId:p})}catch(c){console.error(c),u(c)}},_=c=>new Promise(d=>setTimeout(d,c)),s=O(g);if(a==="unsubscribe")return;if(a==="subscribe"&&e.event==="evm:connect"&&_(500).then(()=>s.evm&&v("evm:connect",s.evm.address)),a==="request")switch(w){case"ton:restoreConnection":return s.ton?o({id:"0",event:"connect",payload:{device:{maxProtocolVersion:2,features:["SendTransaction",{name:"SendTransaction",maxMessages:4}],platform:"browser",appVersion:"1",appName:"hot"},items:s.ton.items}}):u("Connect TON");case"ton:connect":return m();case"ton:send":return i.method==="disconnect"?(P({origin:g,ton:null}),o(null)):s.ton?m():u("Connect TON");case"solana:connect":return s.solana?o({publicKey:s.solana.address}):m();case"solana:disconnect":return P({origin:g,solana:null}),v("solana:disconnect",null),o(null);case"solana:signIn":return s.solana?o({publicKey:s.solana.address}):m();case"solana:signAndSendTransaction":case"solana:signAllTransactions":case"solana:signMessage":return s.solana?m():u("Connect Solana");case"near:getAccounts":return s.near?o([{accountId:s.near.address,publicKey:s.near.publicKey}]):u("Connect NEAR");case"near:signOut":return P({origin:g,near:null}),v("near:signedOut",null),o(null);case"near:hereConnect":case"near:signIn":case"near:signAndSendTransactions":case"near:signAndSendTransaction":case"near:signMessage":return m();case"stellar:signAuthEntry":return u({code:-3,message:'Albedo does not support the "signAuthEntry" function'});case"stellar:getAddress":case"stellar:signTransaction":case"stellar:signMessage":return m();case"ethereum":switch(i.method){case"eth_accounts":return o(s.evm?.address?[s.evm.address]:[]);case"net_version":return o(s.evm?.chain||1);case"eth_chainId":return o(s.evm?"0x"+s.evm.chain.toString(16):"0x1");case"wallet_revokePermissions":return P({origin:g,evm:null}),v("evm:disconnect",null),o(null);case"wallet_requestPermissions":return o({eth_accounts:{}});case"eth_requestAccounts":return s.evm?.address?o([s.evm.address]):await m();case"wallet_switchEthereumChain":{const d=parseInt(i.params[0]?.chainId||i.params[0],16);return s.evm?.address?(await P({origin:g,evm:{...s.evm,chain:d}}),await v("evm:chainChanged",d),o(null)):u("Connect EVM")}case"wallet_watchAsset":return s.evm?.chain?await m():u("Connect EVM");case"wallet_addEthereumChain":{const d=parseInt(i.params[0].chainId,16);return b.chains.find(S=>S.id===d)?(await P({origin:g,evm:{address:s.evm?.address||"",chain:d}}),await v("evm:chainChanged",d),o(null)):u("Unsupported chain")}case"eth_sendTransaction":case"eth_signTransaction":case"eth_signTypedData":case"eth_signTypedData_v3":case"eth_signTypedData_v4":case"personal_sign":return s.evm?.address?m():u("Connect EVM");default:{if(!s.evm?.address)return u("Connect EVM");const d=I[s.evm.chain]||b.createEvmProvider(b.get(s.evm.chain));I[s.evm.chain]=d,d.send(i.method,i.params).then(o).catch(u)}}}}catch{}});
